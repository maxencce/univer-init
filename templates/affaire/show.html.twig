{% extends 'base.html.twig' %}

{% block title %}Affaire
	{{ affaire.code }}
{% endblock %}

{% block body %}
	<div class="w-full px-4 py-6">
		<div class="mb-6 md:mb-8 flex flex-col md:flex-row md:items-center md:justify-between">
			{% set is_editable = currentVersion.statut is defined and currentVersion.statut.value == 'CONTRAT' %}
			<div>
				<h1 class="text-2xl font-bold text-gray-900">Affaire
					<span class="text-gesec-primary">{{ affaire.code }}</span>
				</h1>
				<p class="text-sm text-gray-600 mt-1">{{ currentVersion.description }}</p>
				<p class="text-xs text-gray-500 mt-1">Client :
					{{ affaire.client.nom }}
					• Version :
					{{ currentVersion.versionNumber }}</p>
			</div>
			<div class="mt-4 md:mt-0 flex items-center space-x-3">
				{% if is_granted('ROLE_GESEC') %}
					<a href="{{ path('affaire_edit', {id: currentVersion.id}) }}" class="btn px-4 py-2 bg-blue-600 text-white rounded-lg text-sm font-semibold">Modifier</a>
					<a href="{{ path('affaire_duplicate', {id: affaire.id}) }}" class="px-4 py-2 bg-gray-100 text-gray-800 rounded-lg hover:bg-gray-200 text-sm">Dupliquer</a>
				{% endif %}
				{% if is_editable %}
					<a href="{{ path('affaire_saisie_tableur', {id: currentVersion.id}) }}" class="px-3 py-2 bg-white text-gray-800 rounded-lg ring-1 ring-gray-200 hover:bg-gray-50 text-sm">Saisie quantité</a>
				{% else %}
					<span class="px-3 py-2 bg-gray-100 text-gray-400 rounded-lg text-sm cursor-not-allowed" title="Saisie désactivée : l'affaire n'est pas en statut CONTRAT">Saisie quantité</span>
				{% endif %}
			</div>
		</div>

		<div class="grid {% if is_granted('ROLE_GESEC') %} grid-cols-1 md:grid-cols-3{% else %} grid-cols-2{% endif %} gap-4 mb-6">
			<div class="bg-white rounded-lg p-4">
				<h3 class="text-sm font-medium text-gray-700">Résumé</h3>
				<div class="mt-3">
					<div class="flex items-center justify-between py-2 border-b border-gray-100">
						<div class="text-sm text-gray-600">Lignes BPU</div>
						<div class="text-lg font-semibold text-gray-900">{{ stats.bpuCount }}</div>
					</div>
					<div class="flex items-center justify-between py-2 border-b border-gray-100">
						<div class="text-sm text-gray-600">Sites</div>
						<div class="text-lg font-semibold text-gray-900">{{ stats.sitesCount }}</div>
					</div>
					<div class="flex items-center justify-between py-2">
						<div class="text-sm text-gray-600">Adhérents</div>
						<div class="text-lg font-semibold text-gray-900">{{ stats.adherentsCount }}</div>
					</div>
				</div>
			</div>
			{% if is_granted('ROLE_GESEC') %}
				<div class="bg-white rounded-lg p-4">
					<h3 class="text-sm font-medium text-gray-700">Actions rapides</h3>
					<div class="mt-3 grid{% if is_granted('ROLE_GESEC') %} grid-cols-1{% else %} grid-cols-2{% endif %} gap-2">
						{% if currentVersion.statut is defined and currentVersion.statut.value == 'CONTRAT' %}
							<span class="block px-3 py-2 rounded-md bg-gray-100 text-gray-400 text-sm cursor-not-allowed" title="Modification des BPU désactivée : l'affaire est en statut CONTRAT">Gérer les BPU</span>
						{% else %}
							<a href="{{ path('affaire_add_bpu', {id: currentVersion.id}) }}" class="block px-3 py-2 rounded-md bg-gray-50 hover:bg-gray-100 text-sm text-gray-700">Gérer les BPU</a>
						{% endif %}
						<a href="{{ path('affaire_add_adherent', {id: currentVersion.id}) }}" class="block px-3 py-2 rounded-md bg-gray-50 hover:bg-gray-100 text-sm text-gray-700">Gérer les adhérents</a>
						<a href="{{ path('affaire_affectation', {id: currentVersion.id}) }}" class="block px-3 py-2 rounded-md bg-gray-50 hover:bg-gray-100 text-sm text-gray-700">Affectation des sites</a>
						<form action="{{ path('affaire_new_version', {id: affaire.id}) }}" method="post" onsubmit="return confirm('Créer une nouvelle version de cette affaire ?');">
							<input type="hidden" name="_token" value="{{ csrf_token('newversion' ~ affaire.id) }}">
							<button type="submit" class="w-full text-left px-3 py-2 rounded-md bg-gray-50 hover:bg-gray-100 text-sm text-gray-700">Créer nouvelle version</button>
						</form>
					</div>
				</div>
			{% endif %}
			<div class="bg-white rounded-lg p-4">
				<h3 class="text-sm font-medium text-gray-700">Informations</h3>
				<div class="mt-3 text-sm text-gray-600 space-y-2">
					<div>Début:
						{{ currentVersion.dateDebut ? currentVersion.dateDebut|date('d/m/Y') : '—' }}</div>
					<div>Fin:
						{{ currentVersion.dateFin ? currentVersion.dateFin|date('d/m/Y') : '—' }}</div>
					<div>Statut:
						{{ currentVersion.statut.value ? currentVersion.statut.value : '—' }}</div>
					<div>Code:
						{{ affaire.code }}</div>
				</div>
			</div>
		</div>

		<div class="bg-white rounded-lg p-4">
			<h3 class="text-sm font-medium text-gray-700">Description</h3>
			<div class="mt-3">
				<p class="text-sm text-gray-600">{{ currentVersion.longDescription ?? currentVersion.description }}</p>
			</div>
		</div>
	</div>
{% endblock %}
