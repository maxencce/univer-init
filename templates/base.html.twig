<!DOCTYPE html>
<html lang="fr" class="h-full bg-gray-50">
	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<title>
			{% block title %}GESEC Gestion de Contrat{% endblock %}
		</title>
		<link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 128 128%22><text y=%221.2em%22 font-size=%2296%22>⚫️</text><text y=%221.3em%22 x=%220.2em%22 font-size=%2276%22 fill=%22%23fff%22>sf</text></svg>">
		{% block stylesheets %}
			{{ encore_entry_link_tags('app') }}

			{# Styles globaux pour uniformiser la taille des champs de saisie et définir les couleurs principales #}
			<style>
				:root {
					/* Couleurs modifiables globalement */
					--page-bg: #FFFFFF; /* fond de page (gris très léger) */
					--panel-bg:rgb(243, 243, 243); /* fond des cartes / panneaux */
					--panel-border: rgba(2,6,23,0.06);
					--panel-shadow: 0 6px 18px rgba(2,6,23,0.08);
				}

				/* Forcer le fond de la page via variable pour pouvoir la changer facilement */
				html, body { background-color: var(--page-bg) !important; }

				/* Rendre les blocs de contenu plus visibles : fond, bord et ombre */
				.bg-white {
					background-color: var(--panel-bg) !important;
					border: 1px solid var(--panel-border);
					box-shadow: var(--panel-shadow) !important;
				}

				/* Classe utilitaire si nécessaire pour panels plus légers */
				.panel-light {
					background-color: var(--panel-bg);
					border: 1px solid var(--panel-border);
					box-shadow: 0 4px 10px rgba(2,6,23,0.06);
				}

				/* Cible les champs textuels et selects, sans affecter les checkbox/radio */
				input[type="text"], input[type="email"], input[type="password"], input[type="date"], input[type="number"], input:not([type]), select, textarea {
					font-size: 0.95rem; /* légèrement plus grand que le small par défaut */
					padding: 0.5rem 0.75rem; /* hauteur de champ augmentée */
					border-radius: 0.5rem;
					background-color: var(--panel-bg);
					border: 1px solid rgba(2,6,23,0.12);
					color: #0f172a;
					box-shadow: inset 0 1px 2px rgba(2,6,23,0.03);
					transition: box-shadow 0.15s ease, border-color 0.15s ease;
				}

				input[type="text"]::placeholder, input[type="email"]::placeholder, input[type="password"]::placeholder, textarea::placeholder {
					color: #94a3b8; /* placeholder plus doux */
				}

				select {
					-webkit-appearance: none;
					-moz-appearance: none;
					appearance: none;
					background-image: linear-gradient(45deg, transparent 50%, #94a3b8 50%), linear-gradient(135deg, #94a3b8 50%, transparent 50%);
					background-position: calc(100% - 1.25rem) calc(1em + 2px), calc(100% - 0.75rem) calc(1em + 2px);
					background-size: 6px 6px, 6px 6px;
					background-repeat: no-repeat;
				}
				/* S'assurer de ne pas agrandir les checkbox et radio */
				input[type="checkbox"], input[type="radio"] {
					width: auto;
					height: auto;
				}
			</style>
		{% endblock %}

		{% block javascripts %}
			{{ encore_entry_script_tags('app') }}
			<script>
				// Importer le service de notification pour les messages flash
				document.addEventListener('DOMContentLoaded', function() {
					// Rechercher les messages flash dans le DOM
					const flashMessages = document.querySelectorAll('#flash-messages .flash-message');
					if (flashMessages.length > 0) {
						// Accéder au service de notification
						if (window.notificationService) {
							const { notificationService } = window;
							
							// Traiter chaque message flash
							flashMessages.forEach(flashMessage => {
								const type = flashMessage.dataset.type || 'info';
								const message = flashMessage.dataset.message || '';
								
								if (message) {
									// Afficher la notification selon le type
									switch(type) {
										case 'success':
											notificationService.showSuccess(message);
											break;
										case 'error':
											notificationService.showError(message);
											break;
										case 'warning':
											notificationService.showWarning(message);
											break;
										default:
											notificationService.showInfo(message);
									}
								}
							});
							
							// Nettoyer le conteneur des messages flash
							document.getElementById('flash-messages').innerHTML = '';
						} else {
							console.error('Service de notification non disponible');
							// Afficher les messages en fallback
							flashMessages.forEach(flashMessage => {
								const message = flashMessage.dataset.message || '';
								if (message) {
									alert(message);
								}
							});
						}
					}
				});
			</script>
		{% endblock %}
	</head>
	<body class="h-full">

		<div class="flex flex-col min-h-screen" data-controller="confirm-modal">
			{% if app.user %}
			<nav class="navbar-gesec">
				<div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8">
					<div class="flex h-16 items-center justify-between">
						<div class="flex items-center">
							<div class="flex-shrink-0">
								<a href="{{ path('app_home') }}">
									<svg width="110" viewBox="0 0 1000 330" aria-hidden="true">
										<path data-name="Tracé 1" d="M368 87.6c-3-23.68-21.43-35.52-47.36-35.52-24.42 0-44.41 11.84-51.07 35.52zM268.84 125c3 22.57 22.57 38.85 54.39 38.85 16.65 0 38.49-6.29 48.85-17l28.86 28.49c-19.24 20-50.71 29.6-78.44 29.6-62.91 0-100.28-38.85-100.28-97.31 0-55.51 37.74-95.47 97-95.47 61.06 0 99.16 37.74 92.14 112.85z" fill="#54616c"></path><path data-name="Tracé 2" d="M565.23 66.14a61.56 61.56 0 00-45.14-16.28c-21.43 0-33.3 6.67-33.3 18.13 0 11.85 10.71 18.5 34 20 34.42 2.22 78.07 10 78.07 58.47 0 32.19-26.27 59.94-78.44 59.94-28.86 0-57.73-4.82-84.37-32.57l22.2-32.19c12.95 14.43 42.56 25.17 62.91 25.53 17 .37 32.93-8.51 32.93-21.83 0-12.58-10.36-17.76-36.26-19.24-34.42-2.59-75.49-15.17-75.49-56.61 0-42.19 43.67-57 77-57 28.49 0 49.95 5.55 71 24.06z" fill="#54616c"></path><path data-name="Tracé 3" d="M765.41 87.6C762.45 63.92 744 52.08 718 52.08c-24.42 0-44.39 11.84-51.06 35.52zM666.24 125c3 22.57 22.57 38.85 54.39 38.85 16.65 0 38.49-6.29 48.84-17l28.87 28.49c-19.25 20-50.72 29.6-78.45 29.6-62.91 0-100.28-38.85-100.28-97.31 0-55.51 37.74-95.47 96.95-95.47 61.06 0 99.16 37.74 92.14 112.85z" fill="#54616c"></path><path data-name="Tracé 4" d="M1000 176.78a93.83 93.83 0 01-70.3 28.87c-52.91 0-97-31.82-97-96.58s44-96.58 97-96.58a86.61 86.61 0 0165.86 27l-28.49 30a55.4 55.4 0 00-36.63-14.44 51.33 51.33 0 00-52.6 50q0 2 .06 4c0 34.78 23.68 53.28 51.81 53.28a54.8 54.8 0 0040-15.17z" fill="#54616c"></path><path data-name="Tracé 5" d="M94.71 159.48c-26.89 0-48.86-19.28-48.86-51.9s22-52.65 48.86-52.65c26.52 0 48.49 20.46 48.49 52.65s-22 51.9-48.49 51.9m54.93 17.8c30.72-14 39.4-46.59 39.4-69.7a79.6 79.6 0 00-19.7-55.3l20.84-26.52L156.08 0l-18.57 23.49a74.42 74.42 0 00-42.8-10.63C42.44 12.86 0 49.24 0 107.58s36.36 94 94.7 94c16.36 0 33.27 5.89 41.77 18.46h49.79c-3.86-16.48-14-31.43-36.63-42.71" fill="#54616c"></path><path data-name="Tracé 6" d="M189.41 239.51h-45.84c0 24.24-22.35 40.15-48.86 40.15s-48.87-15.9-48.87-40.15H0c0 50.38 40.54 83.34 94.7 83.34 54.18 0 94.71-32.96 94.71-83.34z" fill="#b58253"></path><path data-name="Tracé 7" d="M94.71 160c-26.89 0-48.86-19.29-48.86-51.9s22-52.66 48.86-52.66c26.52 0 48.49 20.46 48.49 52.66s-22 51.9-48.49 51.9m54.93 17.8c30.72-14 39.4-46.6 39.4-69.7a79.61 79.61 0 00-19.7-55.31l20.84-26.51L156.08.47 137.51 24A74.44 74.44 0 0094.7 13.35C42.44 13.35 0 49.71 0 108.06s36.36 93.57 94.7 93.57a51.89 51.89 0 0141.89 18.88h49.67c-3.86-16.49-14-31.43-36.63-42.72" fill="#54616c"></path><g data-name="Groupe 1" fill="#54616c"><path data-name="Tracé 8" d="M256.68 286.4A17.37 17.37 0 01222 289a19.24 19.24 0 010-2.63V258h5.45v27.64c0 7.4 2.73 14.41 11.88 14.41s11.87-7 11.87-14.41V258h5.45z"></path><path data-name="Tracé 9" d="M267.91 258h6.87l26.6 38.15h.13V258H307v45.93h-6.87l-26.6-38.15h-.13v38.15h-5.45z"></path><path data-name="Tracé 10" d="M318.38 258h5.45v45.93h-5.45z"></path><path data-name="Tracé 11" d="M357.05 266.09a9.54 9.54 0 00-8.37-4.21c-4.8 0-9.8 2.27-9.8 7.72 0 4.21 2.33 6.1 9.67 8.43 7.14 2.27 13.75 4.61 13.75 13.63s-7.85 13.43-16.15 13.43a16.67 16.67 0 01-14.15-6.36l4.68-3.83a11.11 11.11 0 009.8 5.13c4.67 0 10-2.73 10-8 0-5.64-3.83-6.62-12-9.34-6.49-2.14-11.43-5-11.43-12.65a14 14 0 0114.56-13.32 9.45 9.45 0 011.07.09 15.79 15.79 0 0112.86 5.38z"></path><path data-name="Tracé 12" d="M389.36 258H403c8.44 0 16.09 3 16.09 12.58 0 10.06-8.57 12.72-15.05 12.72h-9.2v20.6h-5.45zm5.45 20.24H404c5.45 0 9.21-2.46 9.21-7.59S409.48 263 404 263h-9.2z"></path><path data-name="Tracé 13" d="M425.17 281a24 24 0 1124 24.13 23.32 23.32 0 01-24-22.59c-.02-.54-.02-1.08 0-1.54zm42.14 0a17.39 17.39 0 10.07 1v-1z"></path><path data-name="Tracé 14" d="M516.4 286.4a17.37 17.37 0 01-34.65 2.54 15.39 15.39 0 010-2.54V258h5.45v27.64c0 7.4 2.73 14.41 11.87 14.41s11.87-7 11.87-14.41V258h5.45z"></path><path data-name="Tracé 15" d="M527.61 258h11.74c8.89 0 18.3 1.3 18.3 12.65a12 12 0 01-11.48 12.14l13 21.15h-6.69l-12.45-20.63h-7v20.63h-5.45zm5.45 20.24h4.86c6 0 13.89 0 13.89-7.59 0-6.62-5.77-7.6-11.09-7.6h-7.66z"></path><path data-name="Tracé 16" d="M585.29 258h28.87v5h-23.44v14.4h21.87v5.07h-21.87v16.35h24.6v5.06h-30.05z"></path><path data-name="Tracé 17" d="M654.57 263h-15.18v40.88h-5.45V263h-15.18v-5h35.81z"></path><path data-name="Tracé 18" d="M661 258h11.75c8.88 0 18.29 1.3 18.29 12.65a12 12 0 01-11.48 12.14l13 21.15h-6.68l-12.46-20.63h-7v20.63H661zm5.45 20.24h4.87c6 0 13.88 0 13.88-7.59 0-6.62-5.78-7.6-11.09-7.6h-7.66z"></path><path data-name="Tracé 19" d="M700.64 258h28.88v5h-23.4v14.4H728v5.07h-21.88v16.35h24.59v5.06h-30z"></path><path data-name="Tracé 20" d="M791.6 286.4A17.37 17.37 0 11757 289a16.49 16.49 0 010-2.63V258h5.45v27.64c0 7.4 2.72 14.41 11.87 14.41s11.87-7 11.87-14.41V258h5.45z"></path><path data-name="Tracé 21" d="M802.83 258h6.88l26.6 38.15h.13V258h5.45v45.93H835l-26.6-38.15h-.13v38.15h-5.45z"></path><path data-name="Tracé 22" d="M853.28 258h5.45v45.93h-5.45z"></path><path data-name="Tracé 23" d="M917.8 303.92h-26.66a23.57 23.57 0 1123.61-23.57 20.47 20.47 0 01-11.16 18.75v.13h14.21zm-26.66-5.06a18.5 18.5 0 10-17.77-19.22v.73a17.84 17.84 0 0017.22 18.47h.56z"></path><path data-name="Tracé 24" d="M958.74 286.4a17.37 17.37 0 01-34.65 2.6 19.24 19.24 0 010-2.63V258h5.45v27.64c0 7.4 2.72 14.41 11.87 14.41s11.88-7 11.88-14.41V258h5.45z"></path><path data-name="Tracé 25" d="M970 258h28.87v5h-23.48v14.4h21.86v5.07h-21.86v16.35H1000v5.06h-30z"></path></g><path data-name="Tracé 26" d="M595.87 245.93h5.9l7.27 9.35h-5.26l-5.13-6.62-5 6.62h-4.93z" fill="#54616c"></path>
									</svg>
								</a>
							</div>
							<div class="hidden md:block">
								<div class="ml-10 flex items-baseline space-x-4">
									<a href="{{ path('app_home') }}" class=" rounded-md px-3 py-2 text-sm font-medium">Accueil</a>
									
									{# Liens visibles pour GESEC et ADMIN #}
									{% if is_granted('ROLE_GESEC') %}
									<!-- Menu déroulant Catalogue -->
									<div class="relative" x-data="{ open: false }">
										<button @click="open = !open" @click.away="open = false" class=" rounded-md px-3 py-2 text-sm font-medium inline-flex items-center">
											Catalogue
											<svg class="ml-1 h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
												<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
											</svg>
										</button>
										<div x-show="open" x-cloak class="absolute left-0 mt-2 w-48 rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5 py-1">
											<a href="{{ path('client_index') }}" class="block px-4 py-2 text-sm hover:bg-gray-100">Clients</a>
											<a href="{{ path('site_index') }}" class="block px-4 py-2 text-sm hover:bg-gray-100">Sites</a>
										</div>
									</div>

									{% endif %}
									
									{# Affaires visible pour GESEC et ADHERENT #}
									{% if is_granted('ROLE_ADHERENT') %}
									<a href="{{ path('affaire_index') }}" class=" rounded-md px-3 py-2 text-sm font-medium">Affaires</a>
									{% endif %}
									
									{# Reporting visible pour GESEC et ADHERENT #}
									{% if is_granted('ROLE_GESEC') or is_granted('ROLE_ADHERENT') %}
									<a href="{{ path('reporting_index') }}" class=" rounded-md px-3 py-2 text-sm font-medium">Reporting</a>
									{% endif %}

									{% if is_granted('ROLE_ADMIN') %}
									<!-- Menu déroulant Administration -->
									<div class="relative" x-data="{ open: false }">
										<button @click="open = !open" @click.away="open = false" class=" rounded-md px-3 py-2 text-sm font-medium inline-flex items-center">
											Administration
											<svg class="ml-1 h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
												<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
											</svg>
										</button>
										<div x-show="open" x-cloak class="absolute left-0 mt-2 w-56 rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5 py-1">
											<a href="{{ path('user_index') }}" class="block px-4 py-2 text-sm hover:bg-gray-100">Gestion des utilisateurs</a>
										</div>
									</div>
									{% endif %}
								</div>
							</div>
						</div>
						<div class="hidden md:block">
							<div class="ml-4 flex items-center md:ml-6">
								{% if app.user %}
									<a href="{{ path('profile_show') }}" class="text-sm mr-4 inline-flex items-center px-3 py-1 rounded-md font-medium hover:underline hover:bg-gray-100 nav-user-link">{{ app.user.userIdentifier }}</a>
									<form action="{{ path('app_logout') }}" method="post">
										<input type="hidden" name="_csrf_token" value="{{ csrf_token('logout') }}">
										<button type="submit" class="rounded-md px-3.5 py-1.5 text-sm font-semibold shadow-sm btn-deconnexion">Déconnexion</button>
									</form>
								{% else %}
									<a href="{{ path('app_login') }}" class="rounded-md px-3.5 py-1.5 text-sm font-semibold shadow-sm hover:bg-blue-800">Connexion</a>
								{% endif %}
							</div>
						</div>
						<div class="-mr-2 flex md:hidden">
							<!-- Mobile menu button -->
							<button type="button" class="relative inline-flex items-center justify-center rounded-md p-2" aria-controls="mobile-menu" aria-expanded="false">
								<span class="absolute -inset-0.5"></span>
								<span class="sr-only">Ouvrir le menu</span>
								<!-- Menu icon -->
								<svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true">
									<path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5" />
								</svg>
							</button>
						</div>
					</div>
				</div>

				<!-- Mobile menu -->
				<div class="md:hidden hidden" id="mobile-menu">
					<div class="space-y-1 px-2 pb-3 pt-2 sm:px-3">
						<a href="{{ path('app_home') }}" class=" block rounded-md px-3 py-2 text-base font-medium">Accueil</a>
						
						<!-- Catalogue mobile (GESEC seulement) -->
						{% if is_granted('ROLE_GESEC') %}
						<div x-data="{ open: false }">
							<button @click="open = !open" class=" block rounded-md px-3 py-2 text-base font-medium w-full text-left flex justify-between items-center">
								<span>Catalogue</span>
								<svg class="h-4 w-4" :class="{'rotate-180': open}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
									<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
								</svg>
							</button>
							<div x-show="open" x-cloak class="pl-4">
								<a href="{{ path('client_index') }}" class="block rounded-md px-3 py-2 text-base font-medium">Clients</a>
								<a href="{{ path('site_index') }}" class="block rounded-md px-3 py-2 text-base font-medium">Sites</a>
							</div>
						</div>
						{% endif %}
						
						{# Affaires visible pour GESEC et ADHERENT #}
						{% if is_granted('ROLE_GESEC') or is_granted('ROLE_ADHERENT') %}
						<a href="{{ path('affaire_index') }}" class=" block rounded-md px-3 py-2 text-base font-medium">Affaires</a>
						{% endif %}
						
						{# Reporting visible pour GESEC et ADHERENT #}
						{% if is_granted('ROLE_GESEC') or is_granted('ROLE_ADHERENT') %}
						<a href="{{ path('reporting_index') }}" class=" block rounded-md px-3 py-2 text-base font-medium">Reporting</a>
						{% endif %}
						
						{% if is_granted('ROLE_ADMIN') %}
						<!-- Administration mobile -->
						<div x-data="{ open: false }">
							<button @click="open = !open" class=" block rounded-md px-3 py-2 text-base font-medium w-full text-left flex justify-between items-center">
								<span>Administration</span>
								<svg class="h-4 w-4" :class="{'rotate-180': open}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
									<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
								</svg>
							</button>
							<div x-show="open" x-cloak class="pl-4">
								<a href="{{ path('user_index') }}" class=" block rounded-md px-3 py-2 text-base font-medium">Gestion des utilisateurs</a>
							</div>
						</div>
						{% endif %}
					</div>
					<div class="border-t border-blue-700 pb-3 pt-4">
						<div class="flex items-center px-5">
							{% if app.user %}
								<div class="text-base font-medium">{{ app.user.userIdentifier }}</div>
								<form action="{{ path('app_logout') }}" method="post" class="ml-auto">
									<input type="hidden" name="_csrf_token" value="{{ csrf_token('logout') }}">
									<button type="submit" class="relative flex-shrink-0 rounded-md bg-red-300 p-1">Déconnexion</button>
								</form>
							{% else %}
								<a href="{{ path('app_login') }}" class="block rounded-md px-3 py-2 text-base font-medium">Connexion</a>
							{% endif %}
						</div>
					</div>
				</div>
			</nav>
			{% endif %}

			<main class="flex flex-col flex-1">
				<div class="{% block page_wrapper_class %}h-full mx-auto w-full py-6 sm:px-6 lg:px-8{% endblock %}">
					{# Messages flash cachés qui seront traités par le service de notification #}
					<div id="flash-messages" style="display: none;">
						{% for label, messages in app.flashes %}
							{% for message in messages %}
								<div class="flash-message" data-type="{{ label }}" data-message="{{ message }}"></div>
							{% endfor %}
						{% endfor %}
					</div>
					{% block body %}{% endblock %}
				</div>
			</main>
			{% include 'components/_confirm_modal.html.twig' %}
		</div>

		<!-- Alpine.js pour les menus déroulants -->
		<script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
		<style>
			[x-cloak] { display: none !important; }
		</style>
		<script>
			// Script pour gérer le menu mobile
			document.addEventListener('DOMContentLoaded', function() {
				const mobileMenuButton = document.querySelector('[aria-controls="mobile-menu"]');
				const mobileMenu = document.getElementById('mobile-menu');
				
				if (mobileMenuButton && mobileMenu) {
					mobileMenuButton.addEventListener('click', function() {
						const expanded = this.getAttribute('aria-expanded') === 'true';
						this.setAttribute('aria-expanded', !expanded);
						mobileMenu.classList.toggle('hidden');
					});
				}
			});
		</script>
	</body>
</html>
